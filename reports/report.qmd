---
title: "The Temporal Network of Hospital Patient Transfers Paper"
authors:
    - name: David Wu
    - name: Michael Lydeamore
    - name: Andrew Stewardson
    - name: Tjibbe Donker
    - name: Nic Geard
    - name: OTHER AUTHORS
date: last-modified
format:
    html: default
    pdf: default
---

# Introduction

Antimicrobial resistance is bad. In Victoria, Australia, we have observed CPE, and want to understand how the underlying movement of patients could affect the spread of CPE and other related AMR in the future.
The focus of this paper is on the patient movement network: ways of representing, simplifying, and approximating those patient movements; and how those representations of patient movement affect the spread of a hypothetical infection between hospitals in the Victorian healthcare system.

# Methods

## Generating the temporal network
We have line-listed patient movement data between {start_date} and {end_date}. This allows us to generate exact patient movement networks up to minute precision.
By arranging patient journeys within this dataset, we can construct a network of patient transfers when two consecutive (but not necessarily temporally adjacent) admissions of the same patient occur at different healthcare facilities.
These then define a temporal network where a (single) patient being discharged from hospital $A$ at time $t_1$ and admitted to hospital $B$ at a later time $t_2$, where there are no other event in between, contributes to a weight of 1 on the edge $(A, t_1) \to (B, t_2)$.
To simplify the computational expense of such a network, and to protect patient anonymity, we choose to discretise events in the system. This is done by choosing some window size $W$, and treating events that occur between $t$ and $t+W$ as all occuring at $t$. This causes some transfers to "disappear" depending on the choice of $W$.
The patient transfers can be "indirect", where the patient is not present in the hospital system for some amount of time between consecutive admissions, i.e. when $t_2 \neq t_1$. From inspecting the dataset, we see that there is a significant number of transfers that are indirect, and the time between consecutive admissions is distributed sub-exponentially, witha  heavy tail.
These types of transfers imply causal edges between hospitals that are neither synchronous (occur at the same time), nor persistent (where the effect of a cause at time $t_1$ is not felt over some interval $(t_1, t_2)$), which make it challenging to fit a temporal network generated by this dataset into classical temporal network frameworks of representation.

## Projecting the temporal network
We can project these causal edges by making their effects persistent in a hospital. This reduces the amount of information stored, so in theory should improve performance of simulations.

With a naive approach, an edge $(A, t_1) \to (B, t_2)$ can be decomposed into:

1. $(A, t_1) \to (B, t_1)$ and $(B, t_1) \to \dots \to (B, t_2)$
2. $(A, t_1) \to \dots \to (A, t_2)$ and $(A, t_2) \to (B, t_2)$

This causes an implied increased infection pressure at certain hospital nodes. This sort of projection also loses specificity of temporal causality. By inspecting the temporal network that results from this projection, you cannot tell if a patient is moving from $t_1$ to $t_2$ or to $t_3$. 

There is also a mechanistically distinct projection, where we introduce "home" nodes for each facility. For some facility $A$, the home node is denoted $A'$.
Thus we could also project the edge as 

- $(A, t_1) \to (A', t_1)$ and $(A', t_1) \to \dots \to (A', t_2)$ and $(A', t_2) \to (B, t_2)$.

This is an ideal projection, but is difficult to achieve. Specifically, it is difficult to control the duration that an individual spends in the home node.
However, this projection still loses temporal causal specificty, as above.


### Our solution

We project the temporal network into a series of multilayer networks. Instantaneous movements (consisting of direct hospital-hospital transfers) make up one layer; movements from hospital to home make up another layer; and movements from home to hospital make up the third layer.
By doing this, we can more accurately capture the time that a patient spends at home between hospital visits, but without explicitly tracking individuals (just the number of patients along each path).


## Simulating on Networks

We use a discrete time Markov chain model to simulate the spread of infection. Simulations step forward in timesteps of $\delta t$, and events within the window $\delta t$ are assumed to be independent.
For simplicity, we model the infection as SI or SIS, depending on the choice of removal rate; we assume that all facilities are at capacity all the time, which allows us to remove the explciit tracking of susceptibles.
When individuals are removed, they are randomly chosen to either never return or eventually return (to the hospital system); if they do, they are randomly placed into a transfer bucket which has two properties:

- where they will readmit
- when they will readmit

For a "full" temporal simulation, both where and when are specified; for a "reduced" simulation, only "where" is specified, and "when" falls into one of two buckets: immediately, or not immediately.
We use a "full" temporal simulation with the unprojected temporal network, and a "reduced" simulation for any projection of that temporal network that has lost temporal information.

<Specification of the model here>

| Parameter | Description |
|-----------|---------------------------------------|
| $\beta$   | Rate of infection per unit infected per day |
| $\eta$    | Rate of removal/recovery |
| $\gamma$  | Rate of discharge from hospital |
| $M$       | Transition matrix inferred from network |

# Results

We run a range of experiments.

## Leading results


## Linelist simulations

We can also run this model structure on top of the actual line list, instead of aggregating patient movement into a network.

## No infection simulations 

To isolate the effect of the projections on the movement of patients, we can simulate the model with parmeters $\beta = 0, \eta=0$.

## Home node projection simulations


## Markovian Approximation of movement


# Appendix

## Estimation of parameters for the projected network simulations

The rate / transition matrix that defines the rate of return from home to hospital is characterised by the matrix $M_{in}$, such that

$$M_{in}(i, j, t) = \frac{n_r(i, j, t)}{n_h(i, j, t)},$$

where $i$ is the index for the hospital an individual was at prior to going home, $j$ the index for the hospital an individual is going to from home, $t$ the current time, $n_r$ the number of individuals that are returning from home, and $n_h$ the number of individuals that are currently at home (and will return to a hospital at some point in the future).

We observe $n_r$ in the data, but we do not have any direct observations of $n_h$. We could compute this by iterating through the data, counting the number of individuals going home and returning to hospital, but this is expensive, and not necessarily available in all cases. Instead, we utilise the available values of $n_g$, the number of individuals that go home from hospital. We have a estimated return time distribution for individuals characterised by the pdf $r(\tau)$, so we apply this by estimating $n_h$ as

$$n_h(i, j, t) \approx \int_{t-T}^t n_g(i, j, \tau) r(t - \tau) d\tau.$$

We truncate this approximation at some bandwith time $T$.

The retrun time distribution is presented in @figure-??. We fit a power law model $r(\tau) \sim \tau ^k$ with coefficient $k \approx -0.6$.

## Simulation Details and Model

We keep records of two sets of states:

1. $n(t, x)$, the current number of infected at location $x$. This represents individuals in hospital.
2. $u(t, x, y)$, the current number of individuals that came from location $x$ and will depart for location $y$ at some point in the future. This represents the number of people at home.

Each snapshot can be considered a graph composed of vertices $V$ that correspond to locations, and have edges $E$.

Edges of the temporal network, $e(x, s, y, t)$ from location $x$ at time $s$ to location $y$ at time $t$ with some weight $w$ can be decomposed:

1. if $s = t$, construct an edge $e(x, y)$ with weight $w$
2. if $s \neq t$ construct two edges:
   1. $e_o(x, y, s)$ if it doesn't exist, and add weight $w$
   2. $e_i(x, y, t)$ if it doesn't exist, and add weight $w$


We can alternatively conceptualise this as decomposing the temporal edges into movements to a "home" node for each pair of hospitals. The edges $e_o(x, y, s)$ can be conceptualised as an edge between $x$ and a new "home" node denoted by the ordered pair $(x, y)$ at time $s$.

```{python}
#| echo: false

# we're going to use networkx and its layout engine to draw the diagram cause the other engines are dogwater
import networkx as nx
from matplotlib import pyplot as plt

fig = plt.figure()
grid = fig.add_gridspec(2, 1, hspace=0)
ax1, ax2 = grid.subplots(sharex=True, squeeze=True)
for ax in (ax1, ax2):
    ax.set_box_aspect(1)

ABC = nx.DiGraph(['AB', 'BC', 'BA', 'CB', 'AC', 'CA'])
nx.draw_networkx(ABC, ax=ax1, with_labels=True)

```


## Searching snapshots for information on unlikely paths

We observed some empirical simulated hitting time survival curves that suggested that paths that did exist and were likely on the temporal network did not exist or were very unlikely on the equivalent snapshots. This seems confusing, since the snapshot representation _should_ represent a superset of possible movements.
